name: 'PR - ì´ìŠˆ ë™ê¸°í™”'

on:
  pull_request:
    types: [opened, reopened]

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  sync_meta_from_issue:
    runs-on: ubuntu-latest
    steps:
      - name: ì²« ë²ˆì§¸ ì°¸ì¡° ì´ìŠˆë¡œë¶€í„° assignee/label/milestone ë™ê¸°í™”
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const prOwner = context.repo.owner;
            const prRepo  = context.repo.repo;
            const prNumber = pr.number;
            const body = pr.body || "";

            // 1) PR ë³¸ë¬¸ì—ì„œ "ì²« ë²ˆì§¸" ì´ìŠˆ ì°¸ì¡°(í‚¤ì›Œë“œ ìš°ì„  â†’ ì¼ë°˜ #) ì¶”ì¶œ
            const patterns = [
              /(?:^|\s)(?:close[sd]?|fixe?[sd]?|resolve[sd]?)\s+((?:[\w.-]+\/[\w.-]+)?#\d+)/i,
              /(?:^|\s)((?:[\w.-]+\/[\w.-]+)?#\d+)\b/,
            ];
            let ref = null;
            for (const re of patterns) {
              const m = body.match(re);
              if (m && m[1]) { ref = m[1].trim(); break; }
            }
            if (!ref) {
              core.info("ğŸ” ì°¸ì¡°ëœ ì´ìŠˆë¥¼ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. (ì˜ˆ: #123 ë˜ëŠ” Closes #123)");
              return;
            }

            // owner/repo#123 ë˜ëŠ” #123 íŒŒì‹±
            let issueOwner = prOwner;
            let issueRepo  = prRepo;
            let issueNumber = null;

            if (ref.includes('#')) {
              const [left, numStr] = ref.split('#');
              issueNumber = Number(numStr);
              const leftTrim = left.trim();
              if (leftTrim && leftTrim.includes('/')) {
                const [o, r] = leftTrim.split('/');
                if (o && r) { issueOwner = o; issueRepo = r; }
              }
            }
            if (!issueNumber || Number.isNaN(issueNumber)) {
              core.warning(`âš ï¸ ì´ìŠˆ ë²ˆí˜¸ íŒŒì‹± ì‹¤íŒ¨: ${ref}`);
              return;
            }

            core.info(`ğŸ”— ì²« ë²ˆì§¸ ì°¸ì¡° ì´ìŠˆ: ${issueOwner}/${issueRepo}#${issueNumber}`);

            // 2) ì´ìŠˆ ìƒì„¸ ì¡°íšŒ
            const { data: issue } = await github.rest.issues.get({
              owner: issueOwner,
              repo: issueRepo,
              issue_number: issueNumber,
            });

            const issueAssignees = (issue.assignees || []).map(a => a.login);
            const issueLabels    = (issue.labels || []).map(l => typeof l === 'string' ? l : l.name).filter(Boolean);
            const issueMilestone = issue.milestone ? issue.milestone.number : null;

            // ìš”ì•½ í…ìŠ¤íŠ¸(ì½”ë©˜íŠ¸ìš©)
            let summaryAssignees = issueAssignees.length ? issueAssignees.map(a => `@${a}`).join(", ") : "_ë¹„ì–´ìˆìŒ_";
            let summaryLabels    = issueLabels.length ? issueLabels.map(l => `\`${l}\``).join(", ") : "_ë¹„ì–´ìˆìŒ_";
            let summaryMilestone = issueMilestone ? `#${issueMilestone}` : "_ë¹„ì–´ìˆìŒ_";

            // 2-1) Assignee ë™ê¸°í™”
            if (issueAssignees.length) {
              try {
                await github.rest.issues.addAssignees({
                  owner: prOwner,
                  repo: prRepo,
                  issue_number: prNumber,
                  assignees: issueAssignees,
                });
                core.info(`âœ… ë‹´ë‹¹ì(assignees) ì ìš©: ${issueAssignees.join(", ")}`);
              } catch (e) {
                core.warning(`âš ï¸ ë‹´ë‹¹ì ì ìš© ì‹¤íŒ¨: ${e.message}`);
              }
            } else {
              core.info("â„¹ï¸ ë‹´ë‹¹ì(assignees): ë¹„ì–´ìˆìŒ");
            }

            // 2-2) Label ë™ê¸°í™”
            if (issueLabels.length) {
              try {
                await github.rest.issues.addLabels({
                  owner: prOwner,
                  repo: prRepo,
                  issue_number: prNumber,
                  labels: issueLabels,
                });
                core.info(`âœ… ë¼ë²¨(labels) ì ìš©: ${issueLabels.join(", ")}`);
              } catch (e) {
                core.warning(`âš ï¸ ë¼ë²¨ ì ìš© ì‹¤íŒ¨(ë¼ë²¨ì´ PR ì €ì¥ì†Œì— ì—†ì„ ìˆ˜ ìˆìŒ): ${e.message}`);
              }
            } else {
              core.info("â„¹ï¸ ë¼ë²¨(labels): ë¹„ì–´ìˆìŒ");
            }

            // 2-3) Milestone ë™ê¸°í™”
            if (issueMilestone) {
              if (issueOwner === prOwner && issueRepo === prRepo) {
                try {
                  await github.rest.issues.update({
                    owner: prOwner,
                    repo: prRepo,
                    issue_number: prNumber,
                    milestone: issueMilestone,
                  });
                  core.info(`âœ… ë§ˆì¼ìŠ¤í†¤ ì ìš©: #${issueMilestone}`);
                } catch (e) {
                  core.warning(`âš ï¸ ë§ˆì¼ìŠ¤í†¤ ì ìš© ì‹¤íŒ¨: ${e.message}`);
                }
              } else {
                core.info("ğŸš« ë§ˆì¼ìŠ¤í†¤: ë‹¤ë¥¸ ì €ì¥ì†Œ ì´ìŠˆë¼ ë™ê¸°í™” ìƒëµ");
                summaryMilestone = "_ë‹¤ë¥¸ ì €ì¥ì†Œë¼ ìƒëµ_";
              }
            } else {
              core.info("â„¹ï¸ ë§ˆì¼ìŠ¤í†¤: ë¹„ì–´ìˆìŒ");
            }

            // 3) ê²°ê³¼ ìš”ì•½ ì½”ë©˜íŠ¸ ë‚¨ê¸°ê¸°
            const lines = [];
            lines.push(`ğŸ”„ **ì´ìŠˆ ë©”íƒ€ë°ì´í„° ë™ê¸°í™” ê²°ê³¼**`);
            lines.push(`- ì°¸ì¡° ì´ìŠˆ: **${issueOwner}/${issueRepo}#${issueNumber}**`);
            lines.push(`- ğŸ‘¥ ë‹´ë‹¹ì: ${summaryAssignees}`);
            lines.push(`- ğŸ·ï¸ ë¼ë²¨: ${summaryLabels}`);
            lines.push(`- ğŸ—“ï¸ ë§ˆì¼ìŠ¤í†¤: ${summaryMilestone}`);

            try {
              await github.rest.issues.createComment({
                owner: prOwner,
                repo: prRepo,
                issue_number: prNumber,
                body: lines.join("\n"),
              });
              core.info("âœ… ê²°ê³¼ ìš”ì•½ ì½”ë©˜íŠ¸ë¥¼ PRì— ë“±ë¡í–ˆìŠµë‹ˆë‹¤.");
            } catch (e) {
              core.warning(`âš ï¸ ê²°ê³¼ ì½”ë©˜íŠ¸ ë“±ë¡ ì‹¤íŒ¨: ${e.message}`);
            }
